# Выбор и настройка мониторинга в системе

## Мотивация

На текущий момент система «Александрит» не имеет полноценного мониторинга. Единственный источник данных — Яндекс Метрика — охватывает только пользовательские действия на сайте онлайн-магазина и не покрывает API и внутренние процессы. В результате:

- Мы не знаем о сбоях, пока не получим жалобу от клиента.
- Нет возможности проанализировать, где возникают узкие места.
- Непонятно, какие ресурсы перегружены (например, RabbitMQ, MES).
- Отсутствует контроль SLA/доступности.

Внедрение мониторинга даст:

- Прозрачность технического состояния систем.
- Возможность превентивного реагирования на инциденты.
- Данные для улучшения производительности и UX.
- Повышение доверия со стороны B2B и B2C клиентов.

## Выбор подхода к мониторингу

Мы используем **"Четыре золотых сигнала"** от Google:

1. **Latency (задержки)** — насколько быстро реагируют API и MES.
2. **Traffic (трафик)** — сколько запросов приходит в систему.
3. **Errors (ошибки)** — количество ошибок, особенно 5xx.
4. **Saturation (насыщенность)** — загрузка ресурсов и очередей.

Для RabbitMQ дополнительно используем подход **USE (Utilization, Saturation, Errors)**.

## Метрики и обоснование

| Метрика                                            | Назначение                              | Ярлыки                 |
|----------------------------------------------------|-----------------------------------------|------------------------|
| Number of requests (RPS) for each API              | Отслеживание нагрузки                   | endpoint, method       |
| Response time for each API                         | Отслеживание задержек                   | endpoint               |
| Number of HTTP 5xx                                 | Выявление критических ошибок            | service, endpoint      |
| CPU %, Memory Utilisation (для всех сервисов и БД) | Диагностика насыщенности                | instance_id            |
| Number of connections to DB                        | Диагностика проблем с доступом к БД     | db_service             |
| Number of messages in RabbitMQ                     | Диагностика очередей                    | queue_name             |
| Number of dead-letter messages                     | Утерянные/необработанные сообщения      | queue_name             |
| Number of requests per user (API)                  | Выявление перегрузки от партнёров       | user_id                |
| Number of simultaneous sessions                    | Определение одновременных пользователей | service                |
| Kb transferred (received/sent)                     | Выявление аномалий                      | direction, service     |
| Size of DB, S3                                     | Контроль роста данных                   | db_name / storage_type |

## План действий

1. **Выбор технологии мониторинга**:
   - Prometheus + Grafana для метрик.
   - Exporters для RabbitMQ, Java, C#, DB.
   - Alertmanager для алертов.

2. **Настройка сбора метрик**:
   - Внедрить `Prometheus client` в сервисы.
   - Настроить `RabbitMQ Exporter`.
   - Использовать `Node Exporter` и `JMX Exporter` для Java.
   - Внедрить `dotnet prometheus` пакет в MES.

3. **Разработка дашбордов**:
   - Разделение на: API, RabbitMQ, Базы данных, Пользовательский трафик.

4. **Настройка алертов**:
   - Уведомления по каналам (Slack, Email).
   - Триггеры: задержка > X сек, ошибки > Y%, очередь > Z сообщений.

5. **Обновление документации и обучение команды**:
   - Регламенты на реагирование.
   - Базовые инструкции по Grafana.

## Пороговые значения насыщенности

| Показатель                | Порог                                     | Действие при превышении |
|---------------------------|-------------------------------------------|-------------------------|
| CPU > 85% в течение 5 мин | Автотикет, уведомление DevOps             |
| Очередь > 1000 сообщений  | Alert + масштабирование                   |
| Ошибки 5xx > 2%           | Уведомление + анализ логов                |
| Задержка ответа > 3 сек   | Alert, временная блокировка новых заказов |
| Сессии > 500              | Масштабирование или rate-limiting         |

